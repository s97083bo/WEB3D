<!DOCTYPE html>
<html>
<head>
  <title>UwU</title>
<link rel="icon"  href="03.jpg">
<style>


body {
  overflow: hidden;
}

</style>
</head>
<body>
<h1 style="text-align:center">3W3D HW 4</h1>
<hr>
<div id="container" style="float:left; margin:3px; width:60vw; height:60vw">

</div>

<div style="float:left; margin-left: 10px; width:32vw;">

  <div>

    <br>
  </div>
  <input type=radio class='select' id='placing' name='g' value='place' checked> Place 
   <input type=radio class='select' name='g' value='move'> Move<br>

  <input type=radio class='select' name='g' value='delete'> Delete<br>
  <br>
  
  <div style='background-color:cyan'>
    Furniture Selector:
    <br>
    <input type=radio class='furniture' name='c' value='chair' checked>Chair
    <input type=radio class='furniture' name='c' value='table'>Table
    

  </div>
  <br>
  <button id='clear' style="width:45%">Clear</button>
  <button id='save' style="width:45%">Save</button>
  <button id='restore' style="width:45%">Restore</button>
</div>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://threejs.org/build/three.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>


<script>



var camera, scene, renderer, controls;
var raycaster = new THREE.Raycaster();
var mouse = new THREE.Vector2();
var pickplane;
var cyl;
var thePuck;
var spheres = [];
var spheresParts = [];
var moveTarget = null;
var placing = true,deleting = false,moving = false,
selectTable = false,selectChair = true;
init();
animate();

$('.select').click(function() {
  if ($(this).val() === 'place') {
    //  $('.furniture').val('chair');
    placing = true;
    deleting = false;
    moving = false;
  }
  if ($(this).val() === 'move') {
    moving = true;
    deleting = false;
    placing = false;
  }
  if ($(this).val() === 'delete') {
    deleting = true;
    placing = false;
    moving = false;
  }
});

$('.furniture').click(function() {
  //if($('.select').val()==='place'){
  if ($(this).val() === 'chair') {
    selectChair = true;
    selectTable = false;
  }
  if ($(this).val() === 'table') {
    selectTable = true;
    selectChair = false;
  }
});

$('#clear').click(function() {
  spheres.forEach(function(spheresss) {
    spheresss.remove();
  });
  spheres = [];
  spheresParts = [];
});

$('#save').click(function() {
  var states = [];
  spheres.forEach(function(spheresss) {
    states.push(spheresss.name);
  });
  localStorage.setItem('stateStr', JSON.stringify(states));
});

$('#restore').click(function() {
  var states = JSON.parse(localStorage.getItem('stateStr'));
  states.forEach(function(stateStr) {
    var state = JSON.parse(stateStr);
    if (state.type === "Chair") {
      new Chair(new THREE.Vector3(state.pos[0], state.pos[2], state.pos[1]));
    } else if (state.type === "Table") {
      new Table(new THREE.Vector3(state.pos[0], state.pos[2], state.pos[1]));
    }
  });

});
class Chair {
  constructor(pos) {
    var x = pos.x;
    var y = pos.y;
    var z = pos.z;
    this.allMyParts = [];
    this.origin = new THREE.Mesh(new THREE.SphereGeometry(1, 20, 20), new THREE.MeshNormalMaterial());
    this.origin.position.copy(pos);
    var loader = new THREE.TextureLoader();
    loader.crossOrigin = '';
    var woodTex = loader.load("https://i.imgur.com/41AbQXI.jpg");
    this.box = new THREE.Mesh(new THREE.BoxGeometry(20, 4, 16), new THREE.MeshLambertMaterial({
      map: woodTex,
      side: THREE.DoubleSide
    }));
    this.box.position.set(x, y + 20, z)
    this.box2 = new THREE.Mesh(new THREE.BoxGeometry(20, 4, 16), new THREE.MeshLambertMaterial({color: 0x050505}));
    this.box2.position.set(x, y + 16, z)

    this.leg1 = new THREE.Mesh(new THREE.BoxGeometry(3, 20, 3), new THREE.MeshLambertMaterial({color: 0x050505}));
    this.leg1.position.set(x + 8, y + 8, z + 6)

    this.leg2 = new THREE.Mesh(new THREE.BoxGeometry(3, 20, 3), new THREE.MeshLambertMaterial({color: 0x050505}));
    this.leg2.position.set(x + 8, y + 8, z - 6)

    this.leg3 = new THREE.Mesh(new THREE.BoxGeometry(3, 20, 3), new THREE.MeshLambertMaterial({color: 0x050505}));
    this.leg3.position.set(x - 8, y + 8, z + 6)

    this.leg4 = new THREE.Mesh(new THREE.BoxGeometry(3, 20, 3), new THREE.MeshLambertMaterial({color: 0x050505}));
    this.leg4.position.set(x - 8, y + 8, z - 6)

    this.allMyParts.push(this.origin, this.box, this.box2, this.leg1, this.leg2, this.leg3, this.leg4);
    spheres.push(this);
    spheresParts.push(this.origin, this.box, this.box2, this.leg1, this.leg2, this.leg3, this.leg4)
    scene.add(this.box, this.box2, this.leg1, this.leg2, this.leg3, this.leg4);
    var prop = {
      type: "Chair",
      pos: [this.origin.position.x, this.origin.position.z, this.origin.position.y]};
    this.name = JSON.stringify(prop);
  }
  remove() {
    for (let i = 0; i < this.allMyParts.length; i++) {
      this.allMyParts[i].removeFromParent();
    }
  }
  move(pos) {
    this.origin.position.set(pos.x, pos.y, pos.z);
    this.box.position.set(pos.x, pos.y + 20, pos.z);
    this.box2.position.set(pos.x, pos.y + 16, pos.z);
    this.leg1.position.set(pos.x + 8, pos.y + 8, pos.z + 6);
    this.leg2.position.set(pos.x + 8, pos.y + 8, pos.z - 6);
    this.leg3.position.set(pos.x - 8, pos.y + 8, pos.z + 6);
    this.leg4.position.set(pos.x - 8, pos.y + 8, pos.z - 6);
  }
  isMyParts(object) {
    for (let i = 0; i < this.allMyParts.length; i++) {
      if (this.allMyParts[i] === object) {
        return true;
      }
    }
    return false;
  }
  furnitureType() {
    return "Chair";
  }
}
class Table {
  constructor( pos) {
    var x = pos.x;
    var y = pos.y;
    var z = pos.z;
    this.allMyParts = [];
    this.origin = new THREE.Mesh(new THREE.SphereGeometry(1, 20, 20), new THREE.MeshNormalMaterial());
    this.origin.position.copy(pos);
    var loader = new THREE.TextureLoader();
    //loader.crossOrigin = '';
    var woodTex = loader.load("https://i.imgur.com/41AbQXI.jpg");
    this.box = new THREE.Mesh(new THREE.BoxGeometry(70, 4, 50), new THREE.MeshLambertMaterial({
      map: woodTex,
      side: THREE.DoubleSide
    }));
    this.box.position.set(x, y + 35, z)
    this.box2 = new THREE.Mesh(new THREE.BoxGeometry(70, 4, 50), new THREE.MeshLambertMaterial({color: 0x050505}));
    this.box2.position.set(x, y + 31, z)

    this.leg1 = new THREE.Mesh(new THREE.BoxGeometry(4, 32, 4), new THREE.MeshLambertMaterial({color: 0x050505}));
    this.leg1.position.set(x + 33, y + 14, z + 23)

    this.leg2 = new THREE.Mesh(new THREE.BoxGeometry(4, 30, 4), new THREE.MeshLambertMaterial({color: 0x050505}));
    this.leg2.position.set(x + 33, y + 14, z - 23)

    this.leg3 = new THREE.Mesh(new THREE.BoxGeometry(4, 30, 4), new THREE.MeshLambertMaterial({color: 0x050505}));
    this.leg3.position.set(x - 33, y + 14, z + 23)

    this.leg4 = new THREE.Mesh(new THREE.BoxGeometry(4, 30, 4), new THREE.MeshLambertMaterial({color: 0x050505}));
    this.leg4.position.set(x - 33, y + 14, z - 23)

    this.allMyParts.push(this.origin, this.box, this.box2, this.leg1, this.leg2, this.leg3, this.leg4);
    spheres.push(this);
    spheresParts.push(this.origin, this.box, this.box2, this.leg1, this.leg2, this.leg3, this.leg4)
    scene.add(this.box, this.box2, this.leg1, this.leg2, this.leg3, this.leg4);
    var prop = {
      type: "Table",
      pos: [this.origin.position.x, this.origin.position.z, this.origin.position.y]};
    this.name = JSON.stringify(prop);
  }
  remove() {
    for (let i = 0; i < this.allMyParts.length; i++) {
      this.allMyParts[i].removeFromParent();
    }
  }
  move(pos) {
    this.origin.position.set(pos.x, pos.y, pos.z);
    this.box.position.set(pos.x, pos.y + 35, pos.z);
    this.box2.position.set(pos.x, pos.y + 31, pos.z);
    this.leg1.position.set(pos.x + 33, pos.y + 14, pos.z + 23);
    this.leg2.position.set(pos.x + 33, pos.y + 14, pos.z - 23);
    this.leg3.position.set(pos.x - 33, pos.y + 14, pos.z + 23);
    this.leg4.position.set(pos.x - 33, pos.y + 14, pos.z - 23);
  }
  isMyParts(object) {
    for (let i = 0; i < this.allMyParts.length; i++) {
      if (this.allMyParts[i] === object) {
        return true;
      }
    }
    return false;
  }
  furnitureType() {
    return "Table";
  }
}
function init() {

  var ww = $("#container").innerWidth();
  var hh = $("#container").innerHeight();
  renderer = new THREE.WebGLRenderer();
  renderer.setSize(ww, hh);
  renderer.setClearColor(0x888888);
  $("#container").append(renderer.domElement);
  ////////////////////////////////////////////////
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(50, ww / hh, 1, 1000);
  camera.rotation.y = -Math.PI / 2;
  camera.position.set(0, 300, 300);
  scene.add(camera);
  var directionalLight = new THREE.DirectionalLight(0xffffff, 1.1);
  directionalLight.position.set(-150, 100, -150);
  scene.add(directionalLight);
  var directionalLight2 = new THREE.DirectionalLight(0xffffff, 1.1);
  directionalLight2.position.set(150, 100, 150);
  scene.add(directionalLight2);

  var loader = new THREE.TextureLoader();
  var woodTex = loader.load("https://i.imgur.com/4EmAJL4.jpg");
  woodTex.repeat.set(1, 1);
  woodTex.wrapS = THREE.RepeatWrapping;
  woodTex.wrapT = THREE.RepeatWrapping;
  var grassAlpha = loader.load('https://i.imgur.com/bE01i27.png');
  var floor = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), new THREE.MeshLambertMaterial({
    map: woodTex,
    transparent: true,
    alphaMap: grassAlpha,
    side: THREE.DoubleSide
  }));
  floor.rotation.x = -Math.PI / 2;
  floor.position.set(0, -0.1, 0);
  scene.add(floor);

  var stoneMap = loader.load('https://i.imgur.com/t2W6qJU.jpg');
  var stoneAlpha = loader.load('https://i.imgur.com/xQGW3hZ.png');
  var stones = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), new THREE.MeshLambertMaterial({
    map: stoneMap,
    transparent: true,
    alphaMap: stoneAlpha,
    side: THREE.DoubleSide
  }));
  stones.rotation.x = -Math.PI / 2;
  stones.position.set(0, -0.1, 0);
  scene.add(stones);

  let matArray = [];
  matArray.push(new THREE.MeshLambertMaterial({
    map: loader.load('https://i.imgur.com/t2W6qJU.jpg') }));
  matArray.push(new THREE.MeshLambertMaterial({
  map: loader.load('https://i.imgur.com/t2W6qJU.jpg')}));
  matArray.push(new THREE.MeshLambertMaterial({
    map: loader.load('https://i.imgur.com/FXIKg1c.jpg') }));
  matArray.push(new THREE.MeshLambertMaterial({
    map: loader.load('https://i.imgur.com/FXIKg1c.jpg') }));
  matArray.push(new THREE.MeshLambertMaterial({
    map: loader.load('https://i.imgur.com/t2W6qJU.jpg') }));
  matArray.push(new THREE.MeshLambertMaterial({
    map: loader.load('https://i.imgur.com/t2W6qJU.jpg') }));
  var Tex = loader.load("https://i.imgur.com/FXIKg1c.jpg");
  var stone = new THREE.Mesh(new THREE.BoxGeometry(200, 10, 200), matArray);
  scene.add(stone);
  stone.position.set(-50, 0, -50)

 var wallTex = loader.load('https://i.imgur.com/BgrRLWG.png');
  var wall = new THREE.Mesh(new THREE.PlaneGeometry(300, 75), new THREE.MeshLambertMaterial({
    map: wallTex,
    transparent: true,
    side: THREE.DoubleSide
  }));
  wall.rotation.y = -Math.PI / 2;
  wall.position.set(150, 37, 0);
  scene.add(wall);
 var wall2=wall.clone();
 wall2.rotation.y = 0;
 wall2.position.set(0, 37, 150);
 scene.add(wall2);
 
 var housewallTex = loader.load('https://i.imgur.com/uuPE8Jt.jpg');
  var housewall = new THREE.Mesh(new THREE.PlaneGeometry(200, 150), new THREE.MeshLambertMaterial({
    map: housewallTex,
    side: THREE.DoubleSide
  }));
  housewall.position.set(-50, 75, -150);
  scene.add(housewall);
  var housewall2Tex = loader.load('https://i.imgur.com/cLyxSwY.jpg');
  var housewall2 = new THREE.Mesh(new THREE.PlaneGeometry(200, 150), new THREE.MeshLambertMaterial({
    map: housewall2Tex,
    side: THREE.DoubleSide
  }));
  housewall2.rotation.y = -Math.PI / 2;
  housewall2.position.set(-150, 75, -50);
  scene.add(housewall2);
  
  var backgroundwallTex = loader.load('https://i.imgur.com/m8Ut8fT.png');
  var tree = new THREE.Mesh(new THREE.PlaneGeometry(100, 150), new THREE.MeshLambertMaterial({
    map: backgroundwallTex,
    transparent: true,
    side: THREE.DoubleSide
  }));
  tree.position.set(100, 75, -150);
  var tree2 =tree.clone()
  tree2.rotation.y = -Math.PI / 2;
  tree2.position.set(-250, 75, 100);
  scene.add(tree,tree2);
  var backgroundwall2Tex = loader.load('https://i.imgur.com/OTwcbMn.png');
  var backgroundwall2 = new THREE.Mesh(new THREE.PlaneGeometry(200, 150), new THREE.MeshLambertMaterial({
    map: backgroundwall2Tex,
    transparent: true,
    side: THREE.DoubleSide
  }));
  backgroundwall2.position.set(-250, 75,50);
 // backgroundwall2.rotation.y = -Math.PI / 2;
  scene.add(backgroundwall2);
  
  var floor2Tex = loader.load('https://i.imgur.com/zLvHPRi.jpg');
  var floor2 = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshLambertMaterial({
    map: floor2Tex,
    transparent: true,
    side: THREE.DoubleSide
  }));
  floor2.position.set(-200, 0,100);
  floor2.rotation.x = -Math.PI / 2;
  scene.add(floor2);
  
  var doorTex = loader.load('https://i.imgur.com/yoHUoSe.png');
  var door = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshLambertMaterial({
    map: doorTex,
    transparent: true,
    side: THREE.DoubleSide
  }));
 door.position.set(-195, 35, 149);
 scene.add(door);
  
  /////////////////
  var cyl_geom = new THREE.RingGeometry(5, 10, 32);
  var cyl_mat = new THREE.MeshBasicMaterial({
    color: 0xff1234,
  });
  cyl = new THREE.Mesh(cyl_geom, cyl_mat);
  cyl.rotation.x = -Math.PI / 2;
  cyl.position.set(-20, 0, 20);
  scene.add(cyl);
  pickplane = new THREE.Mesh(new THREE.PlaneGeometry(300, 300),new THREE.MeshBasicMaterial({color: 0xff1234 }));
  pickplane.rotation.x = -Math.PI / 2;
  scene.add(pickplane);
  pickplane.material.visible = false;
  
  controls = new THREE.OrbitControls(camera, renderer.domElement);
  window.addEventListener('resize', onWindowResize, false);
  window.addEventListener('mousemove', onDocumentMouseMove, false);
  window.addEventListener('mousedown', onDocumentMouseDown, false);
  window.addEventListener('mouseup', onMouseUp, false);
  thePuck = null;
}
function onWindowResize() {
  var ww = $("#container").innerWidth();
  var hh = $("#container").innerHeight();
  camera.aspect = ww / hh;
  camera.updateProjectionMatrix();
  renderer.setSize(ww, hh);
}
function onMouseUp(event) {
  if (moveTarget != null && moving === true) {
    var intersects = raycaster.intersectObjects(spheresParts)
    var targetType = moveTarget.furnitureType()
    var prop = {
      type: moveTarget.furnitureType(),
      pos: [moveTarget.origin.position.x, moveTarget.origin.position.z, moveTarget.origin.position.y]
    };
    for (let i = 0; i < spheres.length; i++) {
      if (spheres[i] === moveTarget) {
        spheres[i].name = JSON.stringify(prop);
        console.log(spheres[i].name)
        break;
      }
    }
  }
  thePuck = null;
  moveTarget = null;
  controls.enabled = true;
}
function onDocumentMouseMove(event) {
  event.preventDefault();
  
  var viewportPos = $('#container').get(0).getBoundingClientRect();
  mouse.x = ((event.clientX - viewportPos.left) / $('#container').innerWidth()) * 2 - 1;
  mouse.y = -((event.clientY - viewportPos.top) / $('#container').innerHeight()) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  
  var intersects = raycaster.intersectObject(pickplane);
  if (intersects.length > 0) {
    if (intersects[0].point.x < 50 && intersects[0].point.z < 50) {
      intersects[0].point.y = 5
    }
    cyl.position.copy(intersects[0].point);
    cyl.position.y += 1;
    if (moveTarget === null) return;
    moveTarget.move(intersects[0].point);
    controls.enabled = false;
  }
}
function onDocumentMouseDown(event) {
  event.preventDefault();
  
  var viewportPos = $('#container').get(0).getBoundingClientRect();
  mouse.x = ((event.clientX - viewportPos.left) / $('#container').innerWidth()) * 2 - 1;
  mouse.y = -((event.clientY - viewportPos.top) / $('#container').innerHeight()) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  if (placing === true) { // place
    var intersects = raycaster.intersectObject(pickplane);
    if (intersects.length > 0) {
      cyl.position.copy(intersects[0].point);
      if (intersects[0].point.x < 50 && intersects[0].point.z < 50) {
        intersects[0].point.y = 5
      }
      if (selectChair === true) {
        new Chair(intersects[0].point)
      } else if (selectTable === true) {
        new Table(intersects[0].point)
      }
    }
  } else if (deleting === true) { // delete
    var intersects = raycaster.intersectObjects(spheresParts);
    if (intersects.length > 0) {
      thePuck = intersects[0].object;
      var deleteTarget
      var i = 0;
      for (i = 0; i < spheres.length; i++) {
        if (spheres[i].isMyParts(thePuck)) {
          deleteTarget = spheres[i];
          break;
        }
      }
      deleteTarget.remove();
      for (let j = 0; j < spheresParts.length; j++) {
        if (spheres[i].isMyParts(spheresParts[j])) {
          spheresParts.splice(j, 1);
          j--;
        }
      }
      spheres.splice(i, 1);
    }
  } else if (moving === true) {//move
    var intersects = raycaster.intersectObjects(spheresParts);
    if (intersects.length > 0) {
      thePuck = intersects[0].object;
      for (let i = 0; i < spheres.length; i++) {
        if (spheres[i].isMyParts(thePuck)) {
          moveTarget = spheres[i];
          break;
        }
      }
    }
  }
}
function animate() {
  controls.update();
  requestAnimationFrame(animate);
  render();
}
function render() {
  renderer.render(scene, camera);
}


</script>
</body>
</html>

